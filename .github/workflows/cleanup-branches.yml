# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yamllint disable rule:line-length rule:truthy
name: Cleanup Merged Branches

on:
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday at midnight UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    name: Delete Merged Feature Branches
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: |
          git fetch --prune

      - name: Delete merged feature branches
        run: |
          # Get list of merged feature branches (excluding main)
          MERGED_BRANCHES=$(git branch -r --merged origin/main | grep 'origin/feature/' | sed 's|origin/||' | tr -d ' ')

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "No merged feature branches to delete."
          else
            echo "Deleting merged feature branches:"
            echo "$MERGED_BRANCHES"
            
            for branch in $MERGED_BRANCHES; do
              echo "Deleting branch: $branch"
              git push origin --delete "$branch" || echo "Failed to delete $branch (may not exist)"
            done
          fi

      - name: Summary
        run: |
          echo "âœ… Cleanup complete"
          echo "Merged feature branches have been deleted from remote."
